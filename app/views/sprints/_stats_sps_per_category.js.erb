<%= javascript_tag do %>
  var sps_by_category_data = [
    <%- sps_by_category.each do |pbi_type| -%>
      {
        key: "<%= pbi_type[:category].nil? ? "---" : pbi_type[:category].name %>",
        y: <%= pbi_type[:total] %>
      },
    <%- end -%>
  ];
  nv.addGraph(function() {
    var width = <%= chart_options[:width] %>, height = <%= chart_options[:height] %>;
    var chart = nv.models.pieChart()
      .x(function(d) { return d.key })
      .y(function(d) { return d.y })
      .showLabels(true)
      .labelType("percent")
      .color(d3.scale.category10().range())
      .width(width)
      .height(height);
    d3.select("#stats_sps_per_category")
      .datum(sps_by_category_data)
      .transition().duration(1200)
      .attr('width', width)
      .attr('height', height)
      .call(chart);
    chart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });
    return chart;
  });
<% end %>
